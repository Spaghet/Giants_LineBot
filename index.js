'use strict';
//Lets require/import the HTTP module
var http = require('http');
var qs = require('querystring');
var send = require('./send');
var CONST = require('./const').const;

//Lets define a port we want to listen to
const PORT= process.env.PORT || 5000;

//We need a function which handles requests and send response
function handleRequest(request, response){
if(request.method == "POST"){
      handlePostRequest(request, response);
    return;
}else{
  console.log(request.method);
  response.end("You didn't POST");
}
}

//Create a server
var server = http.createServer(handleRequest);

//Lets start our server
server.listen(PORT, function(){
    //Callback triggered when server is successfully listening. Hurray!
    console.log("Server listening on:", PORT);
});

//Handle stuff
function handlePostRequest(req, res){
  var data = new Buffer(0);
  req.on('data', function(chunk){
    data = Buffer.concat([data, chunk], data.length + chunk.length);
  });
  req.on('end', function(chunk){
    data = JSON.parse(data.toString());
    handleJson(data);
  });
res.writeHead(200, {"Content-type": "text/plain"});
res.end("");
}

function handleJson(lineData){
  for(let i = 0; i < lineData.result.length;i++){
    let content = lineData.result[i].content;
    if(content.opType){
      handleOperation(content);
      return;
    }
      handleMessage(content);
  }
}

function handleOperation(content){
  console.log(content);
}
function handleMessage(content){
  if(content.contentType === CONST.contentType.text){
    send.text(content.from, content.text);
    return;
  }else{
    send.image(content.from, "https://i.ytimg.com/vi/4mwJtAfFwlc/maxresdefault.jpg","data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxMSEhUTExMWFRUXFxoXGBgYGBcXGBcXGBcaFxcYFRcaHSggGBolHRcXITEhJSkrLi4uFx8zODMtNygtLisBCgoKDg0OGxAQGi0lICUuLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSstLS0tLS0tLS0tLf/AABEIAMwAzAMBIgACEQEDEQH/xAAcAAABBQEBAQAAAAAAAAAAAAADAQIEBQYHAAj/xABCEAABAwIEAwYDBQYCCwEAAAABAAIRAyEEBRIxBkFREyJhcYGRMqGxQsHR4fAUI1JygpI0YgczRFRjc4OistLxJP/EABoBAAEFAQAAAAAAAAAAAAAAAAIAAQMEBQb/xAAqEQACAgEDAwQBBAMAAAAAAAAAAQIDEQQSIQUxQRMiMlEjYXGRsRRCof/aAAwDAQACEQMRAD8A6JK8V6Ux9WP1ZIRGzKqadN7ge8BYBc34h4nra9IrPZBBOkx6fmrvivPdDXNBvHz/ACXNatXmUEpBJE8cRYzV/iq8fzn0WvyYYvTqqYisSeWsyB6ql4UysPc17tru+4LbaVmanUtPajW0mkTW6RHGLrC3aP8AVxQK+YV+VV48ipL2kob6Eql6svs0fQh9L+CixeYYkH/EVr9HuHyVHiuI8WHQMTWH9ZWix9Gb7Qd/RZDFYUlx+vVaGns3d2Zuqq29kPqcTYwbYqt/eV6nxNjP96rf3lBOE6x96Slhb/DEbqy5lJVtlzgs4xroJxNa/wDnKs6WOxdicVV/uKTLMvgA729lPfhzFgs+zUtvhmpVpFty0R2Zhiy6P2iqAOeoomIzfENIAxFQ8rvO6LSwZA6Ib8EBcRIULul9k3+PH6IeMzjEgwMRVJ66iI6ndVlXP8YP9prR/ObqTWwpncydwhV6ZsdgNvPkrELX9leymP0DqcS4qLYiqP6yo7+JcWbftVYTse0I/QUPG4UiSLwbqDVuVerlkzro48FieI8cN8XX/vKcOJsaD/iq3rUKqnkx4JrKwFlMmVWjUZdxZiRUbOJeRFw57oPhPI+K1dLPa2tpFV7musQXbeMrmNPfVyHJaMVy9sAbbHy+giU+RYOy5brgEuL5G8qzaVl+H82DWNa8iQALXEcgFpm1B1RZGKxV2Ztk6STB3jfyCsVXZlUFMF0XgmfFOxHPOMsPrcXxoaLDnf8AFZTD4UvqCmNyRf6q1z7F6nET8JuepUvgfDa6rnxIbb1N1Uvnti2WdPXvmka7KsEKbQByEKc5qK1qRwWFKTk8nRQW1YQEtTSEUhNcxDkkRUVaBLnEc91QZzhf3g0/E7bwG0lbB1KDKp81ZLg6Y5T4KamxxZBdWpIqWZe1gknUbjpFlIyrKg/UX+cBS6FMObcgyTJF58lPwlPSYA2aB85lFO5jV0RyEw2G0hSNCeGp2lV85LXCAliD2NipmhI5icEocRQ7pteLKB2epzfASfNabslXMy2HO6EypIyIZxyVGLwbdJJnSLk/csvi8NBkfCRIC6DXwri0t5c1ks8pkSDGqfkFc09j3YKWpqW3JROcINryEF4A807VBOyaWrUiY0lyOpuWm4Spa3xYG4+XMLN0g0bmD7q74exGiq0zZ1vXyRDHYMpy5hptDrOG0CL/AHqyBAsTJ6qmytxfA6HVvvaFZZe7unn3jc80aBI+NdAmYgiY5+CyfF2YPAAa6BMRuSImZ6TZX1ao5zSQIJnf7uqx2Ibqe41dgLeJ3v8AJMxGCx7u87z2XROBMLpwzSRdxLvwXOM2d+9eW2v7Hmuu5DT04ekB/APoszXyxHBp9OWZtlgkhKvLKNgSEmlOCcGpYFkC+nKjnBjmJ+an6UwtTdh1IgjCNbsIRG01IhehCwkwYanBqfCdpT4GcgcJC1EISJxsgoXtKJCUBJCyBNFY3iDCwXOI3Pyj8luiFleL2HTYdZ+76qxS8SRBcsxZzrFU42TaRkXRcWIA5KMwrdh2Oes+RI7TY7FSME/vC8eP62UBpRqBuiwCdo4TxLTSaJ70Rc8x9Vo8JoDZJFyTuOZssBwhU1scYmXDSfTYFb3BYUaBqbdEgSkzUjSwgw7byB3lYfPMUWzPxQAB/EDMweojda7McQ4AQ0wT3jp2b4LGcZubV0tbYtvPQ2t+XgmY5k6jtYk/ELERfbddeyUzQpH/AIbfouU5c+7iTA5ey6lw2f8A81H/AJbVk658I1tAsZZYlibCKmuCz0aSY1oT2pAE5oSQzFTHIhCE5JjIYkSpELZIPCUpgTk+RhpSJSkTDnkoXgE8BEhmIVQcSkdm49I+q0Lmqiz6mHNIMRv5o4fIjn2OX5mZKiNUrMHd8worVv1fE5635ChHw9OSPEhADVJoOuLIwMHTeFqYa893TTMbXIja66NSq2WB4NaXNAdYQOt3CCQT5LfloKJAmfzalLBeBIkeHVcu4l1Gu5umPh9o6c1180g6x+a5jxNau4AEOEQTJht/oIQzCiUOEwdqhju2Ox3PRdMymlopU29GN/8AELDZczUHAAy9wF56i4PuuiFsCFia2fuwbejj7cnjUSdpKjPZf4oXhq5mVTyX9iJQcisUJqKHNG8olIGUSQ4oLivAjqkITNgpYESLy9KAMUJyZK9rRIWBXJE0uXg5IQRqI1BlPYU6BY9yzXFLyG257rSVDZZDi8uLXRaB7yYhSV8ySAnxBnOsW+XkobGyivoGVY5TlxLgSO7z3W6pqMTA2OUiFUwzmgOIt1S0ACR5/NaWpmLajKlPQBTawwIvIFiT5rLUBOyaqxy7kmop9PB13hCnqdpMmQLiQ0EbhbwBYjgCq3sCQQCI1T1W3CsIqlU4uEfaHsR+KwXHFA9pr0lrRALvPr4LoIKzXEGFdiWvoMLZIkSQJI3hNJZQkVWTYEaaThcEBw/P1V7mFbQwu6BUnCZ0tFGpapTkRM8/xV1mNMPaWlc5cpKbUjo6HGUFtMzhc4psFyS4mSTMz4dArfCZi2p0uvPyqi8QWj6LP5tkb6PfpOJbz6hPFQlwiSVk491wa1oPI+hRG1BzEH5LC4LiKqww4z58lp8rzhlYW3TTplEUbYz7FmYKTSh9oOYXi1vUj1UBLhj9J6rxlBI/zFKCf4kw+AnaEbtSdoOhCQO6kJjqjU4kh+sdfqnsUWWeI80anS6W8QiQzRJ0pqRjiLFPKcAQlUHEVDUCBz+660BaqrM6ViY2Sg8SBkt3Bhjl3euQPEqZgKopv1agW3t0tEFOzd4LSSRJNh4eCBluAcYOwV/flciq0uH2IObM0MdYjtDDeXd3P3KnwouFd8Z1AKlJoOzJ9SfyCpMEe+J239loaePsyYuulm1r6Ou8D4AtY9sRIDve/wAlt6I7oneFS8KMmi155tEHzV0ArSKJls0rVNZa2QLd4defgsh+xOq4rTrcCD3SDBEXn3hdGqgRfZZatggMS9zTIDNXobGPGQmYgOEouGL75l4pkzyMltxCt65VHkD3Pr1HG4YzRP8AVInxsresVga9/lZvdOj+Mg46k6NTHQfEEj2CHiKdejSdWe+kaYbJnULdAOvJWNNsyE2s1lWi7DVTpBBDXdLyJ8ig06jLiRa1Dkl7TI1/2bEkhp7GtAOl3dmbg36yFX0KNXDv70j6KxqcJYg1S55a60dr2gMtAAA072AAVhDWRSJa8Dqe8PEHdW7MVrCeUU9PutfKwy0whlrSeYlGeh040iNkrisqUuTWS45KnH52aVok+XJVdbiioNgPZW2Oy5lQy4qqrZdRae89WqfTxyipcrM+1gBxLUPIH0SHiJ/QKVTGEbv7nVHvCssMcOR3GtP1+d1NJ1rnaRRVj/3Kiln7zu0+ys8BnY1DS433aVYNNPaAPRAxGW0n3iD1Cgcq34JlGxecl814IlPaqnBMLREkq0pqENhuSg4mIuphKgZsyWQOqbPIq17jM4fCse52oT3jHlNv14KSGlzg1tgD7rxaGp2LqCnRqVejTHmbD6qxDMmkXpWKEXL6MFxBixVxFRwMidLfJtreEglMyqnLrjl9YAUd+DIGqQZ6clYZPqBfsDaxvMGY+S3q1tSRxVk98nJ+TvWVaG02tYI0tAPnCmB6znDOYaqTbDVG0RIG/qpGMxT9VhAgKUjG5hitDCTcQR4+nis1QxpbW1ljiwtgxfbqoWU4cvqFoP8ArGlgF4mDBjrPNWFHBOZTAnvWm/umHEyOvL6oAtDSDESC52/jb5qe4ptNga50NA7rRI5gEwT7pVzmtf52dH09fhQoSVADuE5Iqqk12LpFqUOkqGMKdWwVqUrGjoj9Ri4R5lGBdRq7SpupCqBA+RJsqKtGd0uGyxocNTbdd1MDRN0Wq1SxngbbkNnmU9pQa6gxj3U3h4aRIeBYgjn19FhstyKqXaAx7ZfqL3tLdAiCJ2jnHVa4EjZxHkYTtTj8TyfNXo6uKjhmfLp8nPduBfsbRZpcW7HUZHoOQSU6AFgVI12smtad1n2zTfBoKG1BqbYU2mq65KsKKDJHIMAoWcVQxknqB6kqcCsf/pJxUYZrRu+q300gun6KWmO+aiQys9Nbvok4xrNOokADvGenNVHE2HfVJw4DmU6bruFxUdAIiPsgGfVY6nWed3k+ZK2mDxlaqwjSGkjeZmGgW6bLZo0npvL5M3VdQdsdseCHhOHhphrZsHX36S5R8LlTW14Jtq7x3sDb3V9lWJqSS94YWtiHQAYjvSOt/ZVFNzqtV7xABOw+0SSRfyV4yzo2T1GMkiNI2NoFtvmi4dhc0OHO991kMux5PaN2DgGkH5x7C602DedADptYcrb/AHp0IyHD2KLsXQaP45PgACSVscTR5jwJHks3wFlZDTiXi7xppTuGG7nf1EADwHitVAuNQnnJuJ2+9OIqabgX1ADMBvpMmE8FEdhtBkXEQfP7yhuXN69YuZ0nT3mlDtSSUwlR69eAqWS+o5COq3UhhVI2oS6BdXNJphOPNLAQppC9CcRZEkRkKqbosSFAxVaDPJT6DpaChJBppJOzCMmEJxZPNangJrU9pSGY9tOUdtkNhRJRYIZDnuWA/wBJdWXUmfwtLiPMgA+wK3i5pxa/tcbVG4Zpp/2tE/NxVrRr8mfor3Vucdi8mbpOWjyPHEVGgSDyANp5TOwWdLYc4KThHkEEOh29j0vJW6n5OenHDaZps0FQ1dLgbk22B6AdZEo7R2TNTNItZu51gwGgeqiYbNxUPfE1AA2RsbWI8laMcHmm4d+4dIA26Dwk7+CMAdkjiNLn27xa4dN3X9iui5dhQ6mDYzdZLF4NpjsTDnaZPvJI5m8LU4IOawD6W5IkMR2tiALACABsABAA8FAzanJpsZp11DEwLU2w57id7SAPFw6qwBUPBHtKtSr9kfuafk06qzh5v0t/6XinERn4apTFzI8z80EvVrmDopPPOIHmbA/NVmJYYa4bFoPusfqlOErF+xs9Ku5db/ciVsSBuqqtX1OgHdHzemSJaoOR5XBc43dv5LJhFYyzdbL3LcKGxN1aGFDpVLXsU91UIdxG4tsKCnEjZV9TEEIfauPMhOmJwGZpSgIeT4ixaeW3kjaLXM+aG2kGmRZP4HXJPL0hcgteCnSo2SYHhyK0qNKex6SGaJlMpxco7XojFImQuIR9cU2uqO2Y0uPkBK5Xhpe9zzu9znnzcST9VreN8whgw7Td8Of/ACg2b6n5BZcAtY4xsFdpzCP6ss6WnvbLsilLpqkxPeMe6k4uhphzSI5x7qM1tx4I9NxcIEHlK212Rxdkt0mw2AxQaYA3sfGfotbw7g6mgtFyAAD0BPJZfD4IN2Nxz8eXzW/4JrAuOsRq7sdCOnmiiAzX5XlTGAGATa/3qzheY2BCVSAmXzbEuZTAZAqPIp07SNbp7xHMNAc4/wAqPhcO2mxtNk6WgNE7mOZ6kmSfNQsOO0xD6m7aINFn87odWd6Qxg8nKZisUyk0veYA9SegaOZPRIRB4gx2hrKfN5k/yD8SitaDQpGYkCPEkmAqTEYOvWca7wKTY3efhYNpA91nM3z91R9Ps5FKjHZzu4j7bh1PTxUWor9StxJKbPTtUzYmkLg7JcPQDSfFLRrCo1r27OAPrzCIFy0lh4OsjLcsoj1xCjVHqwqMkKuxFJzdtlG0izXJMGH+KMyoq97ff2TR5n3Q7WuzJ3FMszUHVRMbWt3U2kyeSOcKnTZC4RRTszFzXBr4APPkLc1b0a0+0pHZYHbgJtdukXKknJPGEDFLyStaEK97KOynUfygKVTwoamwASaLk/F4xtGm6o/Ye5J2ASMAAk7fqVkc8zTtnQLMb8I6nm4/rmpqoZZJCp2PH8le+o6q91R/xOM/gB4DZHbGx2Nj5IFF0pKVa5Vl5NqMYQgo+GQMbhDTdt3eRVthcM2mxlXTrpPGl/8AldyI8U57O0BYTY7HoeRRuG2ubTq0KokCCAZ5nl4LR016msPucP1bpz01mY/FkJ1HQORYSYPWDIE+MLQ4SaTu6ZZLXtnfrB8lWZvgnUaTmPHwkFpHR1x6b+ymYeqWgsLpPw+Ok3J8Oitox2dXwtXU0O6hFVbw/UJotnkP18lZKUAzOW4XsqTGuPeAl52mo7vVD/cXKDmWf4WmRre1zmmQG94g9RGxXOMZmNWrZ9R7gNgSY9uagv8A1ySEX+f8RvxZ0/BSBsyZJPV55nwVMUJj9grjL8FA7So232QeZ6nwUV10a47mTafTT1E1XDuzScJVtNMU3G5lzQfPZXbxCxFXEu1B4PeBkei1uAxja7A4WOxHQrnrPe3I7CzRvTQilzx/0ltC85iC5+lK3EBVmiHJ52HbzATThmfwhOdXCC+shCQbQ0ckJ0BRzW8UB2ILu62/3JJZDTD18XFm3J5BPoYIDvO7zj8k7CYUMubuPNGcUWMCEe5CI5lCxmIawFzjA/WyyOc5+aksZZvzPn+ClqqlNhqOSXxJnod+7Ye7zP8AF+SoGOLt0OlQJMuUhzwNlfUFFYRdprbXPCH1Kmltt+aiteg1610XDYYm5RKKissGdzts2w8EuhXJIhW9LFxE381VNhqIKygkucouqtOOLeTU5zim18K5ttTWy087XUPGgghzhpOxgbm1vmoFCvALdwRdX2LrsrU5+2IkSTNoBPQjqr2n1Sftn3OQ6p0edLc6lmP9Gp4UxH7uLFswCOXmtFKyHAzjFRtosfH/AOrWALRXKOePn7UhMaXu0tBLjyARWjYdSAtKcO3DgNpiNQlx+0fXoq2p1HpLjuaHT9DLV2bU8LyRcBlrKN3Q+p/2t/8AYpcbiCdzKe51lBxBWPKcrJZkzutFoqtNHEEOD5CfhMY6i8PZ6jk4dFGwzrJ7/wBfRLGGXJQVkMM3GAzCnXbIN+bTuPP8UtXBjlZYKnULTraSHDYj0WryPMX1GS4gm10Eq/KMO7S+m+CW/Av5OQv2Gqd3D5qeahTHVT1UD4INuCOzLj9pyl0qTWbBRqtcqtzLHOY0kRKeKb7CislxVxIG6o804hYyQzvH5D1WYxOPqVDDnGJ2FghMYJ2VmGnS7lqunPLCYzF1Kxlx8unoEJjAEtQwY/XRBc5WUvCLCUY84Cvr9FGLi7YIjWSVLa0NFgllRH2ytffCA4fCht3bolTEcggVqpRabUL55YdclH2QWDwuisEL1MKUxgUcpFuEEepHTspFGuW7e6CvKJkrimsGm4fz0UnkkfFvGx8wtvhs6oubIcFyemjtep69VZBYRhazoenvluXD/Q//2Q==" );
  }
}
